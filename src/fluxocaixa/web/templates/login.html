<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Nails Finan√ßas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-100 via-white to-pink-200 flex items-center justify-center">

    <div class="w-full max-w-md bg-white/90 backdrop-blur shadow-2xl rounded-2xl p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-pink-600">Nails Finan√ßas</h1>
            <p class="text-gray-500 mt-2 text-sm">
                Fa√ßa login para acessar seu painel de agendamentos e fluxo de caixa.
            </p>
        </div>

        <!-- Mensagem de erro -->
        <div id="erroBox" class="hidden mb-4 rounded-lg bg-red-50 border border-red-200 px-4 py-3 text-sm text-red-700">
            <span id="erroMsg"></span>
        </div>

        <form id="loginForm" class="space-y-5">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                <input
                    type="email"
                    name="email"
                    required
                    class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-400"
                    placeholder="seuemail@exemplo.com"
                >
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input
                    type="password"
                    name="senha"
                    required
                    class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-400"
                    placeholder="********"
                >
            </div>

            <button
                type="submit"
                id="btnEntrar"
                class="w-full py-2.5 rounded-lg bg-pink-600 text-white font-semibold hover:bg-pink-700 transition flex items-center justify-center gap-2"
            >
                <span id="btnText">Entrar</span>
                <svg id="btnSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
            </button>
        </form>

        <p class="mt-6 text-center text-xs text-gray-400">
            ¬© {{ 2025 }} Nails Finan√ßas. Todos os direitos reservados.
        </p>
    </div>

    <script>
        const form = document.getElementById("loginForm");
        const erroBox = document.getElementById("erroBox");
        const erroMsg = document.getElementById("erroMsg");
        const btnEntrar = document.getElementById("btnEntrar");
        const btnText = document.getElementById("btnText");
        const btnSpinner = document.getElementById("btnSpinner");

        function setLoading(isLoading) {
            if (isLoading) {
                btnEntrar.disabled = true;
                btnText.textContent = "Entrando...";
                btnSpinner.classList.remove("hidden");
            } else {
                btnEntrar.disabled = false;
                btnText.textContent = "Entrar";
                btnSpinner.classList.add("hidden");
            }
        }

        function showError(msg) {
            erroMsg.textContent = msg;
            erroBox.classList.remove("hidden");
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            erroBox.classList.add("hidden");
            setLoading(true);

            try {
                const formData = new FormData(form);

                const resp = await fetch("/auth/login", {
                    method: "POST",
                    body: formData
                });

                if (!resp.ok) {
                    if (resp.status === 401) {
                        showError("E-mail ou senha inv√°lidos.");
                    } else {
                        showError("Erro ao tentar fazer login. Tente novamente.");
                    }
                    setLoading(false);
                    return;
                }

                const data = await resp.json();

                if (!data.access_token) {
                    showError("Resposta inv√°lida do servidor.");
                    setLoading(false);
                    return;
                }

                // üîê Salva o token no cookie (como o backend espera)
                // o get_current_user remove "Bearer " se existir.
                document.cookie = `access_token=Bearer ${data.access_token}; path=/; SameSite=Lax`;

                // ‚úÖ Redireciona para uma p√°gina protegida (ajuste se quiser outra)
                window.location.href = "/agendamento";

            } catch (err) {
                console.error(err);
                showError("Erro de conex√£o com o servidor.");
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>
</html>
