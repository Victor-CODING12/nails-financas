{% extends 'base_nails.html' %}
{% block content %}

<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-pink-600 mb-6">Fluxo de Caixa</h1>

    <!-- GRID PRINCIPAL: ENTRADA / SA√çDA -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- ENTRADA -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-lg font-semibold text-green-600 mb-4">üí∞ Nova Entrada</h2>
            <form id="formEntrada" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                    <input type="date" id="dataEntrada" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-green-400" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Valor (R$)</label>
                    <input type="number" step="0.01" id="valorEntrada" placeholder="Ex: 150.00" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-green-400" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Descri√ß√£o</label>
                    <input type="text" id="descricaoEntrada" placeholder="Ex: Pagamento de cliente Ana" class="w-full border rounded-lg p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categoria</label>
                    <select id="categoriaEntrada" class="w-full border rounded-lg p-2">
                        <option value="">Selecione</option>
                        <option>Servi√ßo</option>
                        <option>Venda de Produto</option>
                        <option>Outros</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition">
                    Adicionar Entrada
                </button>
            </form>
        </div>

        <!-- SA√çDA -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-lg font-semibold text-red-600 mb-4">üí∏ Nova Sa√≠da</h2>
            <form id="formSaida" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                    <input type="date" id="dataSaida" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-red-400" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Valor (R$)</label>
                    <input type="number" step="0.01" id="valorSaida" placeholder="Ex: 250.00" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-red-400" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Descri√ß√£o</label>
                    <input type="text" id="descricaoSaida" placeholder="Ex: Compra de material" class="w-full border rounded-lg p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categoria</label>
                    <select id="categoriaSaida" class="w-full border rounded-lg p-2">
                        <option value="">Selecione</option>
                        <option>Aluguel</option>
                        <option>Fornecedor</option>
                        <option>Funcion√°rio</option>
                        <option>Outros</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-semibold transition">
                    Adicionar Sa√≠da
                </button>
            </form>
        </div>
    </div>

    <!-- RESUMO (AGORA NO TOPO) -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-green-100 text-green-800 p-4 rounded-xl shadow">
            <h3 class="font-semibold text-lg">Total de Entradas</h3>
            <p id="totalEntradas" class="text-2xl font-bold mt-1">R$ 0,00</p>
        </div>
        <div class="bg-red-100 text-red-800 p-4 rounded-xl shadow">
            <h3 class="font-semibold text-lg">Total de Sa√≠das</h3>
            <p id="totalSaidas" class="text-2xl font-bold mt-1">R$ 0,00</p>
        </div>
        <div class="bg-pink-100 text-pink-800 p-4 rounded-xl shadow">
            <h3 class="font-semibold text-lg">Saldo Final</h3>
            <p id="saldoFinal" class="text-2xl font-bold mt-1">R$ 0,00</p>
        </div>
    </div>

    <!-- FILTROS + PDF -->
    <div class="mt-10 bg-white p-6 rounded-xl shadow-md">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
            <h2 class="text-lg font-semibold text-gray-700">üìÖ Filtrar Lan√ßamentos</h2>
            <button id="btnPDF" class="inline-flex items-center gap-2 bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                Gerar Relat√≥rio PDF
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm text-gray-600 mb-1">Data Inicial</label>
                <input type="date" id="filtroInicio" class="w-full border rounded-lg p-2">
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">Data Final</label>
                <input type="date" id="filtroFim" class="w-full border rounded-lg p-2">
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">Categoria</label>
                <select id="filtroCategoria" class="w-full border rounded-lg p-2">
                    <option value="">Todas</option>
                    <option>Servi√ßo</option>
                    <option>Venda de Produto</option>
                    <option>Aluguel</option>
                    <option>Fornecedor</option>
                    <option>Funcion√°rio</option>
                    <option>Outros</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">Tipo</label>
                <select id="filtroTipo" class="w-full border rounded-lg p-2">
                    <option value="">Entradas e Sa√≠das</option>
                    <option value="entrada">Somente Entradas</option>
                    <option value="saida">Somente Sa√≠das</option>
                </select>
            </div>
            <div class="flex items-end gap-2">
                <button id="btnFiltrar" class="flex-1 bg-pink-600 hover:bg-pink-700 text-white py-2 rounded-lg font-semibold transition">
                    Aplicar Filtros
                </button>
                <button id="btnLimpar" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold transition">
                    Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- TABELA DE LAN√áAMENTOS -->
    <div class="mt-10 bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">üßæ Lan√ßamentos Recentes</h2>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead class="bg-pink-50">
                    <tr>
                        <th class="p-2 text-left">Data</th>
                        <th class="p-2 text-left">Descri√ß√£o</th>
                        <th class="p-2 text-left">Categoria</th>
                        <th class="p-2 text-left">Tipo</th>
                        <th class="p-2 text-right">Valor (R$)</th>
                        <th class="p-2 text-center">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaLancamentos"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- jsPDF para gerar PDF no front-end -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
lucide.createIcons();

let lancamentosOriginais = [];
let lancamentosFiltrados = [];

async function carregarLancamentos() {
    let url = "/api/fluxo-caixa";
    const inicio = document.getElementById("filtroInicio").value;
    const fim = document.getElementById("filtroFim").value;

    if (inicio && fim) {
        url += `?inicio=${inicio}&fim=${fim}`;
    }

    const resp = await fetch(url);
    const dados = await resp.json();
    lancamentosOriginais = dados.lancamentos || [];

    aplicarFiltrosERender();
}

function aplicarFiltrosERender() {
    const tabela = document.getElementById("tabelaLancamentos");
    tabela.innerHTML = "";

    const filtroCategoria = document.getElementById("filtroCategoria").value;
    const filtroTipo = document.getElementById("filtroTipo").value;

    let totalEntradas = 0;
    let totalSaidas = 0;

    // Aplica filtros em mem√≥ria
    lancamentosFiltrados = lancamentosOriginais.filter(l => {
        if (filtroCategoria && l.categoria !== filtroCategoria) return false;
        if (filtroTipo && l.tipo !== filtroTipo) return false;
        return true;
    });

    // Ordena por data (recentes primeiro)
    lancamentosFiltrados.sort((a, b) => new Date(b.data) - new Date(a.data));

    lancamentosFiltrados.forEach(l => {
        const tipoLabel = l.tipo === "entrada" ? "Entrada" : "Sa√≠da";
        const cor = l.tipo === "entrada" ? "text-green-600" : "text-red-600";
        const dataFormatada = new Date(l.data).toLocaleDateString("pt-BR", { timeZone: "UTC" });
        const valor = Number(l.valor || 0);

        if (l.tipo === "entrada") totalEntradas += valor;
        if (l.tipo === "saida") totalSaidas += valor;

        tabela.innerHTML += `
            <tr class="border-b hover:bg-pink-50 transition">
                <td class="p-2">${dataFormatada}</td>
                <td class="p-2">${l.descricao || ""}</td>
                <td class="p-2">${l.categoria || "-"}</td>
                <td class="p-2 ${cor} font-semibold">${tipoLabel}</td>
                <td class="p-2 text-right ${cor}">R$ ${valor.toFixed(2)}</td>
                <td class="p-2 text-center">
                    <button onclick="excluirLancamento(${l.id})" class="text-gray-500 hover:text-red-600 transition">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </td>
            </tr>`;
    });

    const saldoFinal = totalEntradas - totalSaidas;
    document.getElementById("totalEntradas").textContent = "R$ " + totalEntradas.toFixed(2);
    document.getElementById("totalSaidas").textContent = "R$ " + totalSaidas.toFixed(2);
    document.getElementById("saldoFinal").textContent = "R$ " + saldoFinal.toFixed(2);

    lucide.createIcons();
}

// üóëÔ∏è Excluir lan√ßamento
async function excluirLancamento(id) {
    if (!confirm("Deseja realmente excluir este lan√ßamento?")) return;

    const resp = await fetch(`/api/fluxo-caixa/${id}`, { method: "DELETE" });
    if (resp.ok) {
        alert("Lan√ßamento exclu√≠do com sucesso!");
        carregarLancamentos();
    } else {
        alert("Erro ao excluir lan√ßamento!");
    }
}

// ‚ûï Adicionar Entrada
document.getElementById("formEntrada").addEventListener("submit", async e => {
    e.preventDefault();
    const payload = {
        tipo: "entrada",
        data: document.getElementById("dataEntrada").value,
        valor: document.getElementById("valorEntrada").value,
        descricao: document.getElementById("descricaoEntrada").value,
        categoria: document.getElementById("categoriaEntrada").value
    };
    await fetch("/api/fluxo-caixa", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });
    e.target.reset();
    carregarLancamentos();
});

// ‚ûñ Adicionar Sa√≠da
document.getElementById("formSaida").addEventListener("submit", async e => {
    e.preventDefault();
    const payload = {
        tipo: "saida",
        data: document.getElementById("dataSaida").value,
        valor: document.getElementById("valorSaida").value,
        descricao: document.getElementById("descricaoSaida").value,
        categoria: document.getElementById("categoriaSaida").value
    };
    await fetch("/api/fluxo-caixa", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });
    e.target.reset();
    carregarLancamentos();
});

// üîç Aplicar filtros
document.getElementById("btnFiltrar").addEventListener("click", () => {
    carregarLancamentos();
});

// üßπ Limpar filtros
document.getElementById("btnLimpar").addEventListener("click", () => {
    document.getElementById("filtroInicio").value = "";
    document.getElementById("filtroFim").value = "";
    document.getElementById("filtroCategoria").value = "";
    document.getElementById("filtroTipo").value = "";
    carregarLancamentos();
});

// üßæ Gerar PDF
function gerarPDF() {
    if (!lancamentosFiltrados.length) {
        alert("N√£o h√° lan√ßamentos filtrados para gerar o relat√≥rio.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(14);
    doc.text("Relat√≥rio de Fluxo de Caixa", 14, 20);

    // Filtros atuais
    const inicio = document.getElementById("filtroInicio").value;
    const fim = document.getElementById("filtroFim").value;
    const categoria = document.getElementById("filtroCategoria").value || "Todas";
    const tipo = document.getElementById("filtroTipo").value || "Entradas e Sa√≠das";

    doc.setFontSize(10);
    let linha = 28;
    doc.text(`Per√≠odo: ${inicio || "-"} at√© ${fim || "-"}`, 14, linha); linha += 5;
    doc.text(`Categoria: ${categoria}`, 14, linha); linha += 5;
    doc.text(`Tipo: ${tipo}`, 14, linha); linha += 8;

    // Cabe√ßalho da tabela
    doc.setFontSize(9);
    doc.text("Data", 14, linha);
    doc.text("Descri√ß√£o", 34, linha);
    doc.text("Cat.", 104, linha);
    doc.text("Tipo", 134, linha);
    doc.text("Valor (R$)", 164, linha, { align: "right" });
    linha += 4;
    doc.line(14, linha, 196, linha);
    linha += 4;

    let totalEntradas = 0;
    let totalSaidas = 0;

    lancamentosFiltrados.forEach(l => {
        if (linha > 280) {
            doc.addPage();
            linha = 20;
        }

        const dataFormatada = new Date(l.data).toLocaleDateString("pt-BR", { timeZone: "UTC" });
        const tipoLabel = l.tipo === "entrada" ? "Entrada" : "Sa√≠da";
        const valor = Number(l.valor || 0);

        if (l.tipo === "entrada") totalEntradas += valor;
        if (l.tipo === "saida") totalSaidas += valor;

        doc.text(dataFormatada, 14, linha);
        doc.text(String(l.descricao || "").substring(0, 38), 34, linha);
        doc.text(String(l.categoria || "-").substring(0, 12), 104, linha);
        doc.text(tipoLabel, 134, linha);
        doc.text(valor.toFixed(2), 164, linha, { align: "right" });

        linha += 5;
    });

    const saldoFinal = totalEntradas - totalSaidas;
    linha += 4;
    doc.line(14, linha, 196, linha);
    linha += 6;

    doc.setFontSize(10);
    doc.text(`Total Entradas: R$ ${totalEntradas.toFixed(2)}`, 14, linha); linha += 5;
    doc.text(`Total Sa√≠das:  R$ ${totalSaidas.toFixed(2)}`, 14, linha); linha += 5;
    doc.text(`Saldo Final:   R$ ${saldoFinal.toFixed(2)}`, 14, linha);

    // üîª Baixa automaticamente o arquivo
    doc.save("relatorio_fluxo_caixa.pdf");
}

document.getElementById("btnPDF").addEventListener("click", gerarPDF);

// Carrega tudo ao abrir a p√°gina
carregarLancamentos();
</script>

{% endblock %}