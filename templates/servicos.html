{% extends 'base_nails.html' %}
{% block content %}

<h1 class="text-3xl font-bold text-pink-600 mb-6">Gerenciamento de Serviços</h1>

<!-- Formulário -->
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Cadastrar Novo Serviço</h2>
    <form id="formServico" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Nome do Serviço</label>
            <input id="nome" type="text" class="w-full border rounded-lg p-2" placeholder="Ex: Esmaltação em Gel" required>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Valor (R$)</label>
            <input id="valor" type="number" step="0.01" class="w-full border rounded-lg p-2" placeholder="Ex: 80.00" required>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Duração (minutos)</label>
            <input id="duracao" type="number" class="w-full border rounded-lg p-2" placeholder="Ex: 60" required>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Descrição</label>
            <input id="descricao" type="text" class="w-full border rounded-lg p-2" placeholder="Ex: Inclui cutícula e esmalte">
        </div>
        <div class="md:col-span-2 flex justify-end mt-4">
            <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-2 rounded-lg font-semibold">
                Adicionar Serviço
            </button>
        </div>
    </form>
</div>

<!-- Lista -->
<div class="bg-white rounded-xl shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4">Serviços Cadastrados</h2>
    <table class="w-full text-left border-collapse">
        <thead>
            <tr class="border-b bg-pink-50 text-pink-700">
                <th>Nome</th>
                <th>Valor</th>
                <th>Duração</th>
                <th>Descrição</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody id="tabelaServicos"></tbody>
    </table>
</div>

<script>
lucide.createIcons();

// --- Funções Principais ---
async function carregarServicos() {
    const resp = await fetch("/api/servicos");
    const data = await resp.json();
    renderTabela(data);
}

function renderTabela(servicos) {
    const tabela = document.getElementById("tabelaServicos");
    tabela.innerHTML = "";

    if (servicos.length === 0) {
        tabela.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum serviço cadastrado.</td></tr>';
        return;
    }

    servicos.forEach(s => {
        tabela.innerHTML += `
            <tr class="border-b hover:bg-pink-50 transition">
                <td>${s.nome}</td>
                <td>R$ ${parseFloat(s.valor).toFixed(2)}</td>
                <td>${s.duracao} min</td>
                <td>${s.descricao || '-'}</td>
                <td class="text-center space-x-2">
                    <button class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded-md" onclick="editarServico(${s.id})">Editar</button>
                    <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md" onclick="excluirServico(${s.id})">Excluir</button>
                </td>
            </tr>`;
    });
}

// --- CADASTRAR / ATUALIZAR ---
const form = document.getElementById("formServico");
let editandoId = null;

form.addEventListener("submit", async e => {
    e.preventDefault();
    const payload = {
        nome: nome.value,
        valor: valor.value,
        duracao: duracao.value,
        descricao: descricao.value
    };

    const method = editandoId ? "PUT" : "POST";
    const url = editandoId ? `/api/servicos/${editandoId}` : "/api/servicos";

    await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    form.reset();
    editandoId = null;
    carregarServicos();
});

// --- EXCLUIR ---
async function excluirServico(id) {
    if (confirm("Deseja excluir este serviço?")) {
        await fetch(`/api/servicos/${id}`, { method: "DELETE" });
        carregarServicos();
    }
}

// --- EDITAR ---
async function editarServico(id) {
    const resp = await fetch("/api/servicos");
    const servicos = await resp.json();
    const s = servicos.find(x => x.id === id);
    if (!s) return;

    nome.value = s.nome;
    valor.value = s.valor;
    duracao.value = s.duracao;
    descricao.value = s.descricao;
    editandoId = id;
}

carregarServicos();
</script>

{% endblock %}